<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNO Quadro ‚Äî –ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .header {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        .header .subtitle {
            color: #6e6e73;
            font-size: 14px;
        }

        /* ‚îÄ‚îÄ Upload Area ‚îÄ‚îÄ */
        .upload-area {
            max-width: 600px;
            margin: 60px auto;
            text-align: center;
        }
        .upload-box {
            border: 2px dashed #c0c0c0;
            border-radius: 16px;
            padding: 48px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-box:hover {
            border-color: #0071e3;
            background: #f0f7ff;
        }
        .upload-box.dragover {
            border-color: #0071e3;
            background: #e8f2ff;
        }
        .upload-box svg {
            width: 48px; height: 48px;
            color: #86868b;
            margin-bottom: 12px;
        }
        .upload-box h2 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        .upload-box p {
            color: #86868b;
            font-size: 14px;
        }
        #fileInput { display: none; }

        /* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
        .main-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
        .toolbar {
            background: #fff;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .toolbar .info {
            flex: 1;
            font-size: 14px;
            color: #6e6e73;
        }
        .toolbar .info strong {
            color: #1d1d1f;
        }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #0071e3;
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) {
            background: #0077ed;
        }
        .btn-secondary {
            background: #e8e8ed;
            color: #1d1d1f;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #dcdce0;
        }
        .btn-success {
            background: #30d158;
            color: #fff;
        }
        .btn-success:hover:not(:disabled) {
            background: #28c04e;
        }
        .btn-danger {
            background: #ff3b30;
            color: #fff;
        }
        .btn-danger:hover:not(:disabled) {
            background: #e6352b;
        }
        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        /* ‚îÄ‚îÄ Size Input ‚îÄ‚îÄ */
        .size-input {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        .size-input input {
            width: 70px;
            padding: 6px 8px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }
        .size-input input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0,113,227,0.15);
        }
        .size-input span {
            color: #86868b;
        }

        /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e8e8ed;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }
        .progress-bar .fill {
            height: 100%;
            background: #0071e3;
            border-radius: 2px;
            transition: width 0.3s;
            width: 0%;
        }
        .progress-text {
            font-size: 13px;
            color: #6e6e73;
            display: none;
            margin-top: 4px;
        }

        /* ‚îÄ‚îÄ Product Cards ‚îÄ‚îÄ */
        .products-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .product-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .product-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .product-num {
            background: #e8e8ed;
            color: #6e6e73;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .product-name {
            flex: 1;
        }
        .product-name h3 {
            font-size: 15px;
            font-weight: 600;
        }
        .product-name .meta {
            font-size: 12px;
            color: #86868b;
            margin-top: 2px;
        }
        .product-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        .status-waiting { background: #f5f5f7; color: #86868b; }
        .status-searching { background: #fff3cd; color: #856404; }
        .status-done { background: #d4edda; color: #155724; }

        /* ‚îÄ‚îÄ Image Grid ‚îÄ‚îÄ */
        .images-area {
            padding: 16px 20px;
            min-height: 60px;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        .image-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
            background: #f5f5f7;
        }
        .image-card:hover {
            border-color: #c0c0c0;
        }
        .image-card.selected {
            border-color: #0071e3;
            box-shadow: 0 0 0 2px rgba(0,113,227,0.25);
        }
        .image-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            background: #fafafa;
            display: block;
        }
        .image-card .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
        }
        .image-card .check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #d2d2d7;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .image-card.selected .check {
            background: #0071e3;
            border-color: #0071e3;
        }
        .image-card.selected .check::after {
            content: '‚úì';
            color: #fff;
            font-size: 14px;
            font-weight: 700;
        }
        .image-card .actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.6));
            display: flex;
            gap: 4px;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: auto;
        }
        .image-card:hover .actions {
            opacity: 1;
        }
        .image-card .actions .btn {
            font-size: 11px;
            padding: 4px 8px;
            pointer-events: auto;
        }
        .image-card .size-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .image-card .bg-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #30d158;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
        }
        .image-card.bg-removed .bg-badge {
            display: block;
        }
        .image-card.bg-removed .size-label {
            left: auto;
            right: 40px;
        }

        /* ‚îÄ‚îÄ Loading States ‚îÄ‚îÄ */
        .placeholder {
            color: #86868b;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e8e8ed;
            border-top-color: #0071e3;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1d1d1f;
            color: #fff;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .toolbar { flex-direction: column; align-items: stretch; }
            .images-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .header { padding: 12px 16px; }
            .main-container { padding: 12px; }
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <h1>üì∏ SNO Quadro</h1>
    <span class="subtitle">–ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Excel</span>
</div>

<!-- Upload Area -->
<div class="upload-area" id="uploadArea">
    <div class="upload-box" id="uploadBox">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
        </svg>
        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª</h2>
        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .xls / .xlsx —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
    </div>
    <input type="file" id="fileInput" accept=".xls,.xlsx,.xlsm">
</div>

<!-- Main Interface -->
<div class="main-container" id="mainContainer">

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="info">
            <strong id="productCount">0</strong> —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞–π–¥–µ–Ω–æ
            ¬∑ <span id="selectedCount">0</span> —Ñ–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ
        </div>

        <div class="size-input">
            <label>–†–∞–∑–º–µ—Ä:</label>
            <input type="number" id="outputWidth" placeholder="–∞–≤—Ç–æ" min="100" max="5000">
            <span>√ó</span>
            <input type="number" id="outputHeight" placeholder="–∞–≤—Ç–æ" min="100" max="5000">
            <span>px</span>
        </div>

        <button class="btn btn-primary" id="btnSearchAll">
            üîç –ò—Å–∫–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ
        </button>
        <button class="btn btn-success" id="btnSave" disabled>
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
        </button>
        <button class="btn btn-secondary" id="btnNewFile">
            üìÅ –î—Ä—É–≥–æ–π —Ñ–∞–π–ª
        </button>
    </div>

    <!-- Progress -->
    <div class="progress-bar" id="progressBar"><div class="fill" id="progressFill"></div></div>
    <div class="progress-text" id="progressText"></div>

    <!-- Products -->
    <div class="products-grid" id="productsGrid"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sessionId = null;
let products = [];
let productImages = {};  // {productIdx: [{id, preview_url, width, height, selected, bgRemoved}]}

// ‚îÄ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const uploadArea = document.getElementById('uploadArea');
const uploadBox = document.getElementById('uploadBox');
const fileInput = document.getElementById('fileInput');
const mainContainer = document.getElementById('mainContainer');
const productsGrid = document.getElementById('productsGrid');
const productCount = document.getElementById('productCount');
const selectedCount = document.getElementById('selectedCount');
const btnSearchAll = document.getElementById('btnSearchAll');
const btnSave = document.getElementById('btnSave');
const btnNewFile = document.getElementById('btnNewFile');
const progressBar = document.getElementById('progressBar');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');

// ‚îÄ‚îÄ‚îÄ Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
uploadBox.addEventListener('click', () => fileInput.click());
uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.classList.add('dragover'); });
uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
uploadBox.addEventListener('drop', e => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => {
    if (fileInput.files.length) handleFile(fileInput.files[0]);
});

async function handleFile(file) {
    const form = new FormData();
    form.append('file', file);

    uploadBox.innerHTML = '<div class="spinner"></div><p style="margin-top:12px">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥...</p>';

    try {
        const resp = await fetch('/upload', { method: 'POST', body: form });
        const data = await resp.json();

        if (data.error) {
            showToast('‚ùå ' + data.error);
            resetUpload();
            return;
        }

        sessionId = data.session_id;
        products = data.products;
        productImages = {};

        showMainInterface();
    } catch (e) {
        showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        resetUpload();
    }
}

function resetUpload() {
    uploadBox.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
        </svg>
        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª</h2>
        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ .xls / .xlsx —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>`;
}

// ‚îÄ‚îÄ‚îÄ Main Interface ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showMainInterface() {
    uploadArea.style.display = 'none';
    mainContainer.style.display = 'block';
    productCount.textContent = products.length;
    renderProducts();
}

function renderProducts() {
    productsGrid.innerHTML = '';
    products.forEach((p, idx) => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.id = `product-${idx}`;
        card.innerHTML = `
            <div class="product-header">
                <div class="product-num">${idx + 1}</div>
                <div class="product-name">
                    <h3>${p.brand} ${p.model}</h3>
                    <div class="meta">–¶–≤–µ—Ç: ${p.color} ¬∑ ${p.raw_name}</div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="searchOne(${idx})">üîç –ò—Å–∫–∞—Ç—å</button>
                <span class="product-status status-waiting" id="status-${idx}">–û–∂–∏–¥–∞–Ω–∏–µ</span>
            </div>
            <div class="images-area" id="images-${idx}">
                <div class="placeholder">–ù–∞–∂–º–∏—Ç–µ ¬´–ò—Å–∫–∞—Ç—å¬ª –∏–ª–∏ ¬´–ò—Å–∫–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ¬ª</div>
            </div>`;
        productsGrid.appendChild(card);
    });
}

// ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function searchOne(idx) {
    const status = document.getElementById(`status-${idx}`);
    const area = document.getElementById(`images-${idx}`);
    status.className = 'product-status status-searching';
    status.textContent = 'üîç –ü–æ–∏—Å–∫...';
    area.innerHTML = '<div class="placeholder"><div class="spinner"></div> –ü–æ–∏—Å–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –Ø–Ω–¥–µ–∫—Å–µ...</div>';

    try {
        const resp = await fetch('/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, product_idx: idx }),
        });
        const data = await resp.json();

        if (data.error) {
            area.innerHTML = `<div class="placeholder">‚ùå ${data.error}</div>`;
            status.className = 'product-status status-waiting';
            status.textContent = '–û—à–∏–±–∫–∞';
            return;
        }

        productImages[idx] = data.images.map(img => ({
            ...img,
            selected: false,
            bgRemoved: false,
        }));

        renderImages(idx);
        status.className = 'product-status status-done';
        status.textContent = `‚úì ${data.images.length} —Ñ–æ—Ç–æ`;
    } catch (e) {
        area.innerHTML = '<div class="placeholder">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
        status.className = 'product-status status-waiting';
        status.textContent = '–û—à–∏–±–∫–∞';
    }
}

btnSearchAll.addEventListener('click', async () => {
    btnSearchAll.disabled = true;
    progressBar.style.display = 'block';
    progressText.style.display = 'block';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
    products.forEach((_, idx) => {
        const status = document.getElementById(`status-${idx}`);
        status.className = 'product-status status-waiting';
        status.textContent = '–í –æ—á–µ—Ä–µ–¥–∏';
    });

    try {
        // –ò—â–µ–º –ø–æ –æ–¥–Ω–æ–º—É (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)
        for (let i = 0; i < products.length; i++) {
            progressFill.style.width = `${(i / products.length) * 100}%`;
            progressText.textContent = `–ü–æ–∏—Å–∫ ${i + 1} –∏–∑ ${products.length}: ${products[i].brand} ${products[i].model}...`;

            await searchOne(i);
        }

        progressFill.style.width = '100%';
        progressText.textContent = `‚úì –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω –¥–ª—è –≤—Å–µ—Ö ${products.length} —Ç–æ–≤–∞—Ä–æ–≤`;
        showToast(`‚úì –ù–∞–π–¥–µ–Ω—ã —Ñ–æ—Ç–æ –¥–ª—è ${products.length} —Ç–æ–≤–∞—Ä–æ–≤`);
    } catch (e) {
        showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
    }

    btnSearchAll.disabled = false;
});

// ‚îÄ‚îÄ‚îÄ Render Images ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderImages(idx) {
    const area = document.getElementById(`images-${idx}`);
    const imgs = productImages[idx] || [];

    if (!imgs.length) {
        area.innerHTML = '<div class="placeholder">–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }

    area.innerHTML = `<div class="images-grid">
        ${imgs.map((img, i) => `
            <div class="image-card ${img.selected ? 'selected' : ''} ${img.bgRemoved ? 'bg-removed' : ''}"
                 id="img-${img.id}" onclick="toggleSelect(${idx}, ${i})">
                <img src="${img.preview_url}" alt="" loading="lazy">
                <div class="check"></div>
                <span class="size-label">${img.width}√ó${img.height}</span>
                <span class="bg-badge">‚úì –§–æ–Ω —É–¥–∞–ª—ë–Ω</span>
                <div class="actions">
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); removeBg(${idx}, ${i})"
                            id="rmbg-${img.id}" ${img.bgRemoved ? 'disabled' : ''}>
                        ${img.bgRemoved ? '‚úì –ì–æ—Ç–æ–≤–æ' : 'ü™Ñ –£–±—Ä–∞—Ç—å —Ñ–æ–Ω'}
                    </button>
                </div>
            </div>
        `).join('')}
    </div>`;
}

function toggleSelect(productIdx, imgIdx) {
    const imgs = productImages[productIdx];
    if (!imgs) return;
    imgs[imgIdx].selected = !imgs[imgIdx].selected;
    renderImages(productIdx);
    updateSelectedCount();
}

function updateSelectedCount() {
    let count = 0;
    for (const imgs of Object.values(productImages)) {
        count += imgs.filter(i => i.selected).length;
    }
    selectedCount.textContent = count;
    btnSave.disabled = count === 0;
}

// ‚îÄ‚îÄ‚îÄ Remove Background ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function removeBg(productIdx, imgIdx) {
    const img = productImages[productIdx][imgIdx];
    const btn = document.getElementById(`rmbg-${img.id}`);
    const card = document.getElementById(`img-${img.id}`);

    btn.disabled = true;
    btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.innerHTML = '<div class="spinner"></div>';
    card.style.position = 'relative';
    card.appendChild(overlay);

    try {
        const resp = await fetch('/remove_bg', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, img_id: img.id }),
        });
        const data = await resp.json();

        if (data.error) {
            showToast('‚ùå ' + data.error);
            btn.disabled = false;
            btn.textContent = 'ü™Ñ –£–±—Ä–∞—Ç—å —Ñ–æ–Ω';
            overlay.remove();
            return;
        }

        img.preview_url = data.preview_url;
        img.width = data.width;
        img.height = data.height;
        img.bgRemoved = true;

        renderImages(productIdx);
        showToast('‚úì –§–æ–Ω —É–¥–∞–ª—ë–Ω');
    } catch (e) {
        showToast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ–Ω–∞');
        btn.disabled = false;
        btn.textContent = 'ü™Ñ –£–±—Ä–∞—Ç—å —Ñ–æ–Ω';
        overlay.remove();
    }
}

// ‚îÄ‚îÄ‚îÄ Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
btnSave.addEventListener('click', async () => {
    const selected = {};
    for (const [idx, imgs] of Object.entries(productImages)) {
        const sel = imgs.filter(i => i.selected).map(i => i.id);
        if (sel.length) selected[idx] = sel;
    }

    if (!Object.keys(selected).length) {
        showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ');
        return;
    }

    const width = parseInt(document.getElementById('outputWidth').value) || 0;
    const height = parseInt(document.getElementById('outputHeight').value) || 0;

    btnSave.disabled = true;
    btnSave.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

    try {
        const resp = await fetch('/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sessionId, selected, width, height }),
        });
        const data = await resp.json();

        if (data.error) {
            showToast('‚ùå ' + data.error);
        } else {
            showToast(`‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.saved.length} —Ñ–æ—Ç–æ ‚Üí ${data.output_dir}`);
        }
    } catch (e) {
        showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }

    btnSave.disabled = false;
    btnSave.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    updateSelectedCount();
});

// ‚îÄ‚îÄ‚îÄ New file ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
btnNewFile.addEventListener('click', () => {
    sessionId = null;
    products = [];
    productImages = {};
    mainContainer.style.display = 'none';
    uploadArea.style.display = 'block';
    resetUpload();
    fileInput.value = '';
    progressBar.style.display = 'none';
    progressText.style.display = 'none';
});

// ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 4000);
}
</script>

</body>
</html>
