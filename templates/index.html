<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SNO Quadro — Поиск фото товаров</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:           #000000;
  --bg-elevated:  #16181c;
  --bg-hover:     #1d1f23;
  --bg-card:      #16181c;
  --border:       #2f3336;
  --text:         #e7e9ea;
  --text-muted:   #71767b;
  --accent:       #1d9bf0;
  --accent-hover: #1a8cd8;
  --success:      #00ba7c;
  --danger:       #f4212e;
  --warning:      #ffd400;
  --radius:       12px;
  --radius-sm:    8px;
  --font:         -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

html { font-size: 15px; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
}
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }
button { cursor: pointer; font-family: var(--font); }
input, select { font-family: var(--font); }

/* ─── Layout ───────────────────────────────────────── */
.app {
  max-width: 1100px;
  margin: 0 auto;
  min-height: 100vh;
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
}

/* ─── Header ───────────────────────────────────────── */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(0,0,0,.85);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 14px;
}
.header-logo {
  width: 32px; height: 32px;
  background: var(--accent);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 16px; color: #fff;
  flex-shrink: 0;
}
.header h1 {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: -0.3px;
}
.header-hint {
  margin-left: auto;
  font-size: 13px;
  color: var(--text-muted);
}

/* ─── Section ──────────────────────────────────────── */
.section {
  border-bottom: 1px solid var(--border);
  padding: 20px 16px;
}
.section-title {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 12px;
}

/* ─── Upload Area ──────────────────────────────────── */
.upload-area {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 32px;
  text-align: center;
  transition: border-color .2s, background .2s;
  cursor: pointer;
}
.upload-area:hover, .upload-area.dragover {
  border-color: var(--accent);
  background: rgba(29,155,240,.06);
}
.upload-area svg { fill: var(--text-muted); margin-bottom: 8px; }
.upload-area p { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
.upload-file-input { display: none; }

.file-info {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 16px;
  background: var(--bg-elevated);
  border-radius: var(--radius-sm);
  margin-top: 12px;
  font-size: 14px;
}
.file-info .name { font-weight: 600; flex: 1; }
.file-info .count { color: var(--accent); font-weight: 600; }

/* ─── Buttons ──────────────────────────────────────── */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 8px 20px;
  border-radius: 9999px;
  font-size: 14px;
  font-weight: 700;
  border: none;
  transition: background .15s, opacity .15s;
}
.btn:disabled { opacity: .5; cursor: not-allowed; }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover:not(:disabled) { background: var(--bg-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-sm { padding: 4px 14px; font-size: 13px; }
.btn-icon {
  width: 34px; height: 34px; padding: 0;
  border-radius: 50%; background: transparent; border: none;
  color: var(--text-muted);
  display: flex; align-items: center; justify-content: center;
  transition: background .15s, color .15s;
}
.btn-icon:hover { background: rgba(29,155,240,.1); color: var(--accent); }

/* ─── Action Bar ───────────────────────────────────── */
.action-bar {
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  padding-top: 4px;
}

/* ─── Product List ─────────────────────────────────── */
.product-list { list-style: none; }
.product-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  transition: background .15s;
}
.product-item:hover { background: var(--bg-hover); }
.product-item:last-child { border-bottom: none; }
.product-header { display: flex; align-items: center; gap: 10px; }
.product-num {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--bg-hover);
  font-size: 12px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-muted); flex-shrink: 0;
}
.product-name { font-weight: 600; font-size: 15px; flex: 1; }
.product-raw { font-size: 13px; color: var(--text-muted); margin-top: 2px; }
.product-actions { display: flex; gap: 6px; align-items: center; }

/* ─── Image Grid ───────────────────────────────────── */
.images-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px;
  margin-top: 12px;
}
.image-card {
  position: relative;
  background: var(--bg-elevated);
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  overflow: hidden;
  cursor: pointer;
  transition: border-color .15s, transform .1s;
}
.image-card:hover { border-color: var(--text-muted); transform: translateY(-1px); }
.image-card.selected { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
.image-card img {
  display: block; width: 100%;
  aspect-ratio: 1; object-fit: contain;
  background: #fff;
}
.image-meta {
  padding: 6px 8px; font-size: 11px;
  color: var(--text-muted);
  display: flex; flex-direction: column; gap: 3px;
}
.image-meta .dims { font-weight: 600; color: var(--text); }
.image-meta .source-link {
  white-space: nowrap; overflow: hidden;
  text-overflow: ellipsis; max-width: 100%;
}
.image-meta .source-link a { color: var(--accent); font-size: 11px; }
.card-actions {
  position: absolute; top: 6px; right: 6px;
  display: flex; gap: 4px;
  opacity: 0; transition: opacity .15s;
}
.image-card:hover .card-actions { opacity: 1; }
.card-actions .btn-icon {
  width: 28px; height: 28px;
  background: rgba(0,0,0,.7); color: #fff;
  border-radius: 50%; backdrop-filter: blur(4px);
}
.card-actions .btn-icon:hover { background: var(--accent); }

.check-badge {
  position: absolute; top: 6px; left: 6px;
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--accent);
  display: none; align-items: center; justify-content: center;
}
.image-card.selected .check-badge { display: flex; }

/* ─── Save Bar ─────────────────────────────────────── */
.save-bar {
  position: sticky; bottom: 0;
  background: rgba(0,0,0,.9);
  backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  padding: 12px 16px;
  display: none; align-items: center;
  gap: 12px; flex-wrap: wrap; z-index: 100;
}
.save-bar.visible { display: flex; }
.save-bar label { font-size: 13px; color: var(--text-muted); }
.save-bar input[type="number"] {
  width: 72px; padding: 6px 10px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text); font-size: 14px; text-align: center;
}
.save-bar input[type="number"]:focus { border-color: var(--accent); outline: none; }
.save-count { font-size: 14px; font-weight: 600; }

/* ─── Spinner ──────────────────────────────────────── */
.spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid transparent; border-top-color: currentColor;
  border-radius: 50%; animation: spin .6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ─── Toast ────────────────────────────────────────── */
.toast-container {
  position: fixed; bottom: 80px; left: 50%;
  transform: translateX(-50%); z-index: 200;
  display: flex; flex-direction: column; gap: 8px;
  pointer-events: none;
}
.toast {
  background: var(--accent); color: #fff;
  padding: 10px 20px; border-radius: 9999px;
  font-size: 14px; font-weight: 600;
  white-space: nowrap;
  animation: fadeUp .3s ease;
  pointer-events: auto;
}
.toast.error { background: var(--danger); }
.toast.success { background: var(--success); }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ─── Progress Bar ─────────────────────────────────── */
.progress-bar-wrap {
  height: 3px; background: var(--bg-hover);
  border-radius: 2px; overflow: hidden; display: none;
}
.progress-bar-wrap.active { display: block; }
.progress-bar {
  height: 100%; background: var(--accent);
  transition: width .3s ease; width: 0%;
}

/* ─── Empty State ──────────────────────────────────── */
.empty-state {
  text-align: center; padding: 48px 16px;
  color: var(--text-muted); font-size: 14px;
}
.empty-state svg { fill: var(--text-muted); margin-bottom: 12px; }

/* ─── Responsive ───────────────────────────────────── */
@media (max-width: 640px) {
  .images-grid { grid-template-columns: repeat(2, 1fr); }
  .header h1 { font-size: 17px; }
  .header-hint { display: none; }
}
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-logo">Q</div>
    <h1>SNO Quadro</h1>
    <span class="header-hint">Поиск фото товаров из Excel</span>
  </div>

  <!-- Upload Section -->
  <div class="section" id="upload-section">
    <div class="section-title">Загрузка файла</div>
    <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
      <svg width="40" height="40" viewBox="0 0 24 24"><path d="M19.35 10.04A7.49 7.49 0 0012 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 000 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
      <p>Перетащите .xls / .xlsx файл или нажмите для выбора</p>
      <input type="file" id="file-input" class="upload-file-input" accept=".xls,.xlsx,.xlsm">
    </div>
    <div id="file-info" class="file-info" style="display:none">
      <span class="name" id="file-name"></span>
      <span class="count" id="product-count"></span>
    </div>
  </div>

  <!-- Progress -->
  <div style="padding: 0 16px;" id="progress-section">
    <div class="progress-bar-wrap" id="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <!-- Actions -->
  <div class="section" id="actions-section" style="display:none">
    <div class="action-bar">
      <button class="btn btn-primary" id="btn-search-all">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        Искать все фото
      </button>
      <button class="btn btn-outline" id="btn-select-all-best">Выбрать лучшие</button>
      <span id="search-status" style="font-size:13px; color:var(--text-muted)"></span>
    </div>
  </div>

  <!-- Product List -->
  <div id="products-container"></div>

  <!-- Empty State -->
  <div class="empty-state" id="empty-state">
    <svg width="48" height="48" viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>
    <p>Загрузите Excel-файл с товарами, чтобы начать поиск фото</p>
  </div>
</div>

<!-- Save Bar -->
<div class="save-bar" id="save-bar">
  <span class="save-count" id="save-count">0 выбрано</span>
  <label>Размер:</label>
  <input type="number" id="out-width" placeholder="Ш" value="0" min="0">
  <span style="color:var(--text-muted)">&times;</span>
  <input type="number" id="out-height" placeholder="В" value="0" min="0">
  <span style="font-size:12px; color:var(--text-muted)">(0 = оригинал)</span>
  <button class="btn btn-success" id="btn-save" style="margin-left:auto">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>
    Сохранить
  </button>
</div>

<!-- Toasts -->
<div class="toast-container" id="toasts"></div>

<script>
// ─── State ────────────────────────────────────────────
let sessionId = null;
let products = [];
let selectedImages = {};

// ─── Elements ─────────────────────────────────────────
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');
const emptyState = document.getElementById('empty-state');
const actionsSection = document.getElementById('actions-section');
const productsContainer = document.getElementById('products-container');
const saveBar = document.getElementById('save-bar');
const saveCount = document.getElementById('save-count');
const progressWrap = document.getElementById('progress-wrap');
const progressBar = document.getElementById('progress-bar');

// ─── Toast ────────────────────────────────────────────
function toast(msg, type) {
  const el = document.createElement('div');
  el.className = 'toast' + (type ? ' ' + type : '');
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ─── Progress ─────────────────────────────────────────
function showProgress(pct) {
  progressWrap.classList.add('active');
  progressBar.style.width = pct + '%';
}
function hideProgress() {
  progressWrap.classList.remove('active');
  progressBar.style.width = '0%';
}

// ─── Drag & Drop ──────────────────────────────────────
uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
uploadArea.addEventListener('drop', e => {
  e.preventDefault(); uploadArea.classList.remove('dragover');
  if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleUpload(e.dataTransfer.files[0]); }
});
fileInput.addEventListener('change', () => { if (fileInput.files.length) handleUpload(fileInput.files[0]); });

// ─── Upload ───────────────────────────────────────────
async function handleUpload(file) {
  const fd = new FormData();
  fd.append('file', file);
  showProgress(15);
  try {
    const res = await fetch('/upload', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.error) { toast(data.error, 'error'); hideProgress(); return; }
    sessionId = data.session_id;
    products = data.products;
    selectedImages = {};
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('product-count').textContent = data.count + ' товаров';
    fileInfo.style.display = 'flex';
    actionsSection.style.display = 'block';
    emptyState.style.display = 'none';
    showProgress(100);
    setTimeout(hideProgress, 500);
    renderProducts();
    toast('Загружено ' + data.count + ' товаров', 'success');
  } catch (e) { toast('Ошибка загрузки', 'error'); hideProgress(); }
}

// ─── Render Products ──────────────────────────────────
function renderProducts() {
  productsContainer.innerHTML = '';
  products.forEach((p, idx) => {
    const item = document.createElement('div');
    item.className = 'product-item';
    item.id = 'product-' + idx;
    item.innerHTML =
      '<div class="product-header">' +
        '<span class="product-num">' + (idx + 1) + '</span>' +
        '<div style="flex:1">' +
          '<div class="product-name">' + esc(p.brand) + ' ' + esc(p.model) + ' ' + esc(p.color) + '</div>' +
          '<div class="product-raw">' + esc(p.raw_name) + '</div>' +
        '</div>' +
        '<div class="product-actions">' +
          '<button class="btn btn-outline btn-sm" onclick="searchProduct(' + idx + ')" id="btn-search-' + idx + '">Искать</button>' +
        '</div>' +
      '</div>' +
      '<div class="images-grid" id="images-' + idx + '"></div>';
    productsContainer.appendChild(item);
  });
}

// ─── Search Single Product ────────────────────────────
async function searchProduct(idx) {
  const btn = document.getElementById('btn-search-' + idx);
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Поиск...';
  try {
    const res = await fetch('/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, product_idx: idx }),
    });
    const data = await res.json();
    if (data.error) { toast(data.error, 'error'); return; }
    renderImages(idx, data.images);
    toast(data.images.length + ' фото — ' + products[idx].brand + ' ' + products[idx].model, 'success');
  } catch (e) { toast('Ошибка поиска', 'error'); }
  finally { btn.disabled = false; btn.innerHTML = 'Искать'; }
}

// ─── Search All ───────────────────────────────────────
document.getElementById('btn-search-all').addEventListener('click', async () => {
  const btn = document.getElementById('btn-search-all');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Идёт поиск...';
  const status = document.getElementById('search-status');
  for (let i = 0; i < products.length; i++) {
    status.textContent = (i + 1) + ' / ' + products.length;
    showProgress(((i + 1) / products.length) * 100);
    await searchProduct(i);
  }
  btn.disabled = false;
  btn.innerHTML =
    '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> Искать все фото';
  status.textContent = 'Готово!';
  hideProgress();
  toast('Поиск завершён!', 'success');
});

// ─── Render Images ────────────────────────────────────
function renderImages(productIdx, images) {
  const grid = document.getElementById('images-' + productIdx);
  grid.innerHTML = '';
  if (!images.length) {
    grid.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:13px;">Ничего не найдено</div>';
    return;
  }
  images.forEach(img => {
    const card = document.createElement('div');
    card.className = 'image-card';
    card.dataset.imgId = img.id;
    card.dataset.productIdx = productIdx;

    let domain = '';
    try { if (img.source_url) domain = new URL(img.source_url).hostname.replace('www.', ''); } catch(e) {}

    card.innerHTML =
      '<div class="check-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="#fff"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div>' +
      '<div class="card-actions">' +
        '<button class="btn-icon" title="Убрать фон" onclick="event.stopPropagation(); removeBg(\'' + img.id + '\',' + productIdx + ')">' +
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-1-.01-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>' +
        '</button>' +
      '</div>' +
      '<img src="' + img.preview_url + '" alt="" loading="lazy">' +
      '<div class="image-meta">' +
        '<span class="dims">' + img.width + '&times;' + img.height + '</span>' +
        (domain ? '<span class="source-link"><a href="' + esc(img.source_url) + '" target="_blank" rel="noopener" title="' + esc(img.source_url) + '">' + esc(domain) + '</a></span>' : '') +
      '</div>';

    card.addEventListener('click', () => toggleSelect(card, productIdx, img.id));
    grid.appendChild(card);
  });
}

// ─── Select / Deselect ────────────────────────────────
function toggleSelect(card, productIdx, imgId) {
  if (!selectedImages[productIdx]) selectedImages[productIdx] = new Set();
  const set = selectedImages[productIdx];
  if (set.has(imgId)) { set.delete(imgId); card.classList.remove('selected'); }
  else { set.add(imgId); card.classList.add('selected'); }
  updateSaveBar();
}
function updateSaveBar() {
  let total = 0;
  for (const k in selectedImages) total += selectedImages[k].size;
  saveCount.textContent = total + ' выбрано';
  saveBar.classList.toggle('visible', total > 0);
}

// ─── Select Best ──────────────────────────────────────
document.getElementById('btn-select-all-best').addEventListener('click', () => {
  document.querySelectorAll('.images-grid').forEach(grid => {
    const first = grid.querySelector('.image-card:not(.selected)');
    if (first) first.click();
  });
});

// ─── Remove Background ───────────────────────────────
async function removeBg(imgId, productIdx) {
  toast('Удаление фона...', '');
  try {
    const res = await fetch('/remove_bg', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, img_id: imgId }),
    });
    const data = await res.json();
    if (data.error) { toast(data.error, 'error'); return; }
    const card = document.querySelector('[data-img-id="' + imgId + '"]');
    if (card) {
      card.querySelector('img').src = data.preview_url;
      const dims = card.querySelector('.dims');
      if (dims) dims.textContent = data.width + '\u00d7' + data.height;
    }
    toast('Фон удалён!', 'success');
  } catch (e) { toast('Ошибка', 'error'); }
}

// ─── Save ─────────────────────────────────────────────
document.getElementById('btn-save').addEventListener('click', async () => {
  const sel = {};
  for (const k in selectedImages) { if (selectedImages[k].size) sel[k] = [...selectedImages[k]]; }
  if (!Object.keys(sel).length) { toast('Ничего не выбрано', 'error'); return; }
  const width = parseInt(document.getElementById('out-width').value) || 0;
  const height = parseInt(document.getElementById('out-height').value) || 0;
  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Архивация...';
  try {
    const res = await fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, selected: sel, width, height }),
    });
    if (!res.ok) {
      const err = await res.json();
      toast(err.error || 'Ошибка', 'error');
      return;
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sno_quadro_' + sessionId + '.zip';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast('ZIP-архив скачан!', 'success');
  } catch (e) { toast('Ошибка сохранения', 'error'); }
  finally {
    btn.disabled = false;
    btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg> Сохранить';
  }
});

// ─── Utils ────────────────────────────────────────────
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
